---
title: Packaging Software on OBS
permalink: Tools/Sailfish_SDK/OBS_Packaging
parent: Sailfish SDK
layout: default
nav_order: 400
---

This page deals specifically with building packages using the [Open Build Service](/Services/Development/Open_Build_Service) instance.

This requires the user to create a home project, and then create a package
under that project, with the appropriate `_service` file to specify how the
project should be built and packaged. Once the build has been triggered, OBS
will attempt to pull in the required dependencies and build the package.

## Setting up the (Home) Project

To create an account on OBS, follow the instructions on [the Chum help page](https://github.com/sailfishos-chum/main#user-content-submitting-actively-maintained-software).

After creating a user account you are automatically the owner of the so-called "Home Project" named `home:$username`.
You can create various packages in that project and also create sub-projects.

## Adding a Package

Click "Create Package" in your project if using the Web Interface, or `osc mkpac mypackage` if using `osc`.

## Adding the sources

There are about three common "packaging formats" used in Sailfish OS development, which are described under [Packaging Formats](https://docs.sailfishos.org/Tools/Sailfish_SDK/Building_packages/#packaging-formats):

 - Plain Tarball
 - "Application Repository": `tar_git` with source code repository
 - "Packaging Repository": `tar_git` with upstream submodule

A packaging repository is a git repository which contains just the build
instructions and some other files (like patches) to package software for
Sailfish OS, with the actual source code living in a git submodule of this
repository.

### Plain Tarball sources

Usually, nothing special needs to be done if you want to build software from a source tarball.

You just populate the OBS package source like this:

```
    application.spec
    application-1.2.3.tar.gz
```

OBS will pick up both and run the build.

To get the source information into OBS, either upload them using the Web Interface, or use the `osc` tool:

```
cd my:project:mypackage
cp /path/to/mypackage.tar.bz2 .
cp /path/to/mypackage.spec .
osc add *
osc commit
```

### `tar_git` sources

`tar_git` is a OBS Service which clones a repository from a public git hoster,
creates a tarball from it, extracts the build information, and places all those
files into the OBS Package source location.

To get the service configured on OBS, create a file called `_service` with the following content:
```
<services>
  <service name="tar_git">
  <param name="url">https://github.com/orgname/reponame.git</param>
  <param name="branch"></param>
  <param name="revision"></param>
  <param name="token"/>
  <param name="debian">N</param>
  <param name="dumb">N</param>
</service>
</services>
```

and then either upload them using the Web Interface, or use the `osc` tool:
```
osc mkpac mypackage # create a new OBS package
cd mypackage
cp /path/to/_service .
osc add _service
osc commit
```


#### Understanding version mangling performed by `tar_git`

Before starting the build process, OBS will perform certain changes to the
cloned .spec file. This mainly affects the contents of the `%{version}` and
`%{revision}` macros.

For some examples, see below.

`%specialversion` will consist of:
 - if a tag parameter was specified in the `_service`, it will be used as the version
 - if a branch parameter was specified in the `_service`, it will be appended to the name, along with the hash of the git ref, prepended by the letter "g".
 - if no tag parameter was specified in the `_service`, but a branch name was, it will contain the value of the *latest* tag in the branch, and the branch name, timestamp, and git ref hash appended to it.

`%specialrevision` will have the format X.Y.Z where:
 - X is always 1
 - Y is a counter that roughly corresponds to the number of revisions of the OBS package source.
 - Z is a counter starting at 1 and increasing each time OBS decides to automatically rebuild the package (usually because a dependency was rebuilt or newly published)

Note that these auto-generated revision and version parameters will replace the
`%version` and `%revision` macros in the spec file throughout the OBS build
process. So you cannot use literal version or revision contents in your build
setup. If you need those, you should parse `%version` and `%revision`.


#### Understanding the source structure and tarballs generated by `tar_git`

The tarball produced by the service has the following properties:

 - it will be named `_service:tar_git:%{name}-%{specialversion}-%{specialrevision}.tar.bz2` (see above about the `special` variables)
 - it will contain a directory `%{name}-%{specialversion}-%{specialrevision}`
 - the directory will:
   - contain the content of the repository, but will not include the `.git` directory (so any git calls in your build process will not function).
   - contain clones of all submodules (usually the "upstream" submodule), also without `.git`
   - the same applies to submodules within submodules.

The service will also extract `rpm` sub-directory from the source repo and place its contents in the OBS package root.
So the root may end up looking like this:

```
  _service
  _service:tar_git:foo-1.2+git3.tar.bz2
  _service:tar_git:foo.spec
  _service:tar_git:foo.changes
  _service:tar_git:foo-patchbar.diff
```


**Some Examples**

     - url: https://github.com/orgname/foo.git
     - branch: development
     - revision: *empty*

`_service:tar_git:foo-2.1+development.20240215221650.74.g0773230.tar.bz2` if the development branch contains a tag called 2.1

     - url: https://github.com/orgname/foo.git
     - branch: development
     - revision: 2.2

`_service:tar_git:foo-2.2+development.20240215221650.74.g0773230.tar.bz2`

     - url: https://github.com/orgname/foo.git
     - branch: *empty*
     - revision: 2.2+git3

`_service:tar_git:foo-2.2+git3.tar.bz2`


#### Adjust the %setup macro parameters and other paths

The name of the tarball must be the first `Source:` line in the .spec file.

You should name it
```
Source: %{name}-%{version}.tar.bz2
```

You can choose a literal string as the name, but you must use the `%{version}` macro.

(Note that `tar_git` will pick up the compression format you want to use from the extension, and will create the tarball accordingly.)

**If you are building a "Packaging Repository"**

Because of the structure of the tarball explained above, usually the `%prep`
section of .spec files will have to be adjusted to use the submodule directory
as the main source.

So if the upstream submodule is called "upstream", the line should look like

```
%prep
%setup -q -n %{name}-%{version}/upstream
```
You can choose a literal string as the name, but you must use the `%{version}` macro.

Similarly, if you change working directories in the build process, be aware of where the actual source code is located relative to `%{_builddir}`:

`%{_builddir}/%{name}-%{version}/upstream`

On the other hand, the contents of the `rpm` sub-directory will be in the
package root, not under `rpm` during the build. Usually, this does not affect you
though, as OBS sets the `%{_sourcedir}` macro accordingly, so things like
`%SOURCE2` will work as intended.

#### Adjust the build requirements (BuildRequires).

The building service runner setup used on OBS is more bare-bones than the one
used in the Sailfish SDK, also with regard to the pre-installed packages.  If
you are adapting a .spec file coming from a project developed in the SDK, it is
likely you are missing some build requirements even though the package compiled
fine under the SDK.

Typically this involves the Qt dependencies, so you will need to add lines like the following:

```
BuildRequires:  pkgconfig(Qt5Qml)
BuildRequires:  pkgconfig(Qt5Quick)
BuildRequires:  pkgconfig(Qt5Widgets)
BuildRequires:  pkgconfig(Qt5Xml)
```

### Common errors

Whenever you encounter an error and have attempted to remedy it, run either
`osc service rr` from the locally checked out OBS package, or "Trigger
Services" from the Web Interface.

**ERROR: no packaging in this git clone**

Your project does either not contain a spec file in the `rpm` directory.

**ERROR: couldn't clone foo**

Check the `url` parameter in the `_service` file.
Also, check the settings on your git host. The repository may be set to private.
And be sure to use a clone URL, not a web view of the repo (like git-web).

```
  <param name="url">https://github.com/sailfishos-chum/qt6.git</param>
  <param name="branch">gcc</param>
```

**ERROR: Need single spec file in rpm**

Your project does contain a directory called `rpm`, but that directory contains more than one .spec file, so `tar_git` gets confused.

There are three possible solutions for that.

 1. delete one of the .spec files in the repo ;)
 1. name the OBS package or the spec file so their names match exactly. `tar_git` will accept a spec file that has the same name as the project.

 Note that if you actually want to build all the spec files, you can either use OBS Links (`_link`), or `_multibuild` files to achieve that.
 Either create links that correspond to the names of the other spec files or create a `_multibuild` file using the spec file names as `flavor`:

```
<multibuild>
  <flavor>foo</flavor>
  <flavor>bar</flavor>
</multibuild>
```
**ERROR: couldn't determine version from spec file**

Something is fishy about the `Version:` line in the .spec, or it is missing completely

**ERROR: Source filename in .spec must end in .tar.gz, .tgz, .tar.bz2 or .tar.xz**

The (first) `Source:` or `SourceX:` line in your .spec file is malformed. Be
sure to use one of the file extensions mentioned in the error message.

**Unresolvable: nothing Provides foo**

This is related to `BuildRequires:` in the .spec file.

Reasons include:

 - The dependency is not available in the OBS repositories you have configured in the OBS Project's `meta` configuration.
 - The dependency is available, but does not meet version requirements

If your BuildRequires: uses something like  `pkgconfig()` or `qml()`, try if
specifying the RPM package name (usually `package-devel`) helps. If it does, file an issue with the
package maintainer to include proper RPM `Provides` metadata.

**Blocked: downloading 1 dod packages**

This is a rare error which means one of the build dependencies is known to the OBS system, but the package can not be accessed for the builder to install.
You can not fix this yourself, you have to report this to the OBS maintainers.
