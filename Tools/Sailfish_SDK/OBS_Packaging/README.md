---
title: Packaging Software on OBS
permalink: Tools/Sailfish_SDK/OBS_Packaging
parent: Sailfish SDK
layout: default
nav_order: 400
---

This page deals specifically with building packages using the [Open Build Service](/Services/Development/Open_Build_Service) instance.

This requires the user to create a home project, and then create a package
under that project, with the appropriate `_service` file to specify how the
project should be built and packaged. Once the build has been triggered, OBS
will attempt to pull in the required dependencies and build the package.

## Setting up the Home Project

To create an account on Chum, follow the instructions on [the Chum help page](https://github.com/sailfishos-chum/main#user-content-submitting-actively-maintained-software).

After creating a user account you are automatically the owner of the so-called "Home Project" named `home:$username`.
You can create various packages in that project and also create sub-projects.

## Adding a Package

Click "Create Package" in your project.

### `tar_git`

### Plain tarball

### Other

### Adjusting Spec files and build systems for `tar_git`

Common modifications required to get RPMs built on the OBS:

#### Understanding version mangling performed by `tar_git`

Before starting the build process, OBS will perform certain changes to the
cloned .spec file. This mainly affects the contents of the %{version} and
%{revision} macros.

For some examples, see below.

`%specialversion` will consist of:
 - if a tag parameter was specified in the `_service`, it will be used as the version
 - if a branch parameter was specified in the `_service`, it will be appended to the name, along with the hash of the git ref, prepended by the letter "g".
 - if no tag parameter was specified in the `_service`, but a branch name was, it will contain the value of the *latest* tag in the branch, and the branch name, timestamp, and git ref hash appended to it.

`%specialrevision` will have the format X.Y.Z where:
 - X is always 1
 - Y is a counter that roughly corresponds to the number of revisions of the OBS package source.
 - Z is a counter starting at 1 and increasing each time OBS decides to automatically rebuild the package (usually because a dependency was rebuilt or newly published)

Note that these auto-generated revision and version parameters will replace the
`%version` and `%revision` macros in the spec file throughout the OBS build
process. So you cannot use literal version or revision contents in your build
setup. If you need those, you should parse `%version` and `%revision`.


#### Understanding the source structure and tarballs generated by `tar_git`

The service clones the repository and produces a tarball from it, which you should use as a `Source` in the .spec file.

The tarball produced has the following properties:

 - it will be named `_service:tar_git:%{name}-%{specialversion}-%{specialrevision}.tar.bz2` (see above)
 - it will contain a directory `%{name}-%{specialversion}-%{specialrevision}`
 - the directory will:
   - contain the content of the repository, but will not include the `.git` directory (so any git calls in your build process will not function).
   - contain clones of all submodules (usually the "upstream" submodule), also without `.git`
   - the same applies to submodules within submodules.

The service will also extract `rpm` sub-directory from the source repo and place its contents in the OBS package root.
So the root may end up looking like this:

```
  _service
  _service:tar_git:foo-1.2+git3.tar.bz2
  _service:tar_git:foo.spec
  _service:tar_git:foo.changes
  _service:tar_git:foo-patchbar.diff
```


#### Examples
```
  <param name="url">https://github.com/nephros/foo.git</param>
  <param name="branch">development</param>
  <param name="revision"></param>
```
`_service:tar_git:foo-2.1+development.20240215221650.74.g0773230.tar.bz2` if the development branch contains a tag called 2.1, 

```
  <param name="url">https://github.com/nephros/foo.git</param>
  <param name="branch">development</param>
  <param name="revision">2.2</param>
```
`_service:tar_git:foo-2.2+development.20240215221650.74.g0773230.tar.bz2`

```
  <param name="url">https://github.com/nephros/foo.git</param>
  <param name="branch"></param>
  <param name="revision">2.2+git3</param>
```
`_service:tar_git:foo-2.2+git3.tar.bz2`


#### Adjust the %setup macro parameters and other paths

The name of the tarball must be the first `Source:` line in the .spec file.

You should name it
```
Source: %{name}-%{version}.tar.bz2

```

You can choose a literal string as the name, but you must use the %{version} macro.

Because of the structure of the tarball explained above, usually the `%prep`
section of .spec files will have to be adjusted to use the submodule directory
as the main source.

So if the upstream submodule is called "upstream", the line should look like

```
%prep
%setup -q -n %{name}-%{version}/upstream
```
You can choose a literal string as the name, but you must use the %{version} macro.

Similarly, if you change working directories in the build process, be aware of where the actual source code is located relative to `%{_builddir}`:

`%{_builddir}/%{name}-%{version}/upstream`

On the other hand, the contents of the `rpm` sub-directory will be in the
package root, not under `rpm` during the build. Usually, this does not affect you
though, as OBS sets the `%{_sourcedir}` macro accordingly, so things like
`%SOURCE2` will work as intended.

#### Adjust the build requirements (BuildRequires).

The building service runner setup used on OBS is more barebones than the one used in the Sailfish SDK, including the pre-installed packages.
If you are adapting a .spec file coming from a project developed in the SDK, it is likely you are missing some build requirements even though the package compiled fine under the SDK.

Typically this involves the Qt dependencies, so you will need to add lines like the following:

```
BuildRequires:  pkgconfig(Qt5Qml)
BuildRequires:  pkgconfig(Qt5Quick)
BuildRequires:  pkgconfig(Qt5Widgets)
BuildRequires:  pkgconfig(Qt5Xml)
```

### Common errors

#### ERROR: no packaging in this git clone

Your project does either not contain the file, `rpm/application.spec`, or the
`rpm` directory contains more than one .spec file.  In the latter case, see
###TODO on how to deal with such a structure.

### ERROR: couldn't clone foo

Check the `url` parameter in the `_service` file.
Also, check the settings on your git host. The repository may be set to private.
And be sure to use a clone URL, not a web view of the repo (like git-web).

```
  <param name="url">https://github.com/sailfishos-chum/qt6.git</param>
  <param name="branch">gcc</param>
```

### ERROR: Need single spec file in rpm

Your project does contain a directory called `rpm`, but that directory contains more than one .spec file, so `tar_git` gets confused.

There are three possible solutions for that.

 1. delete one of the .spec files in the repo ;)
 1. name the OBS package or the spec file so their names match exactly. `tar_git` will then pick up the spec file that has the same name as the project.

 Note that if you actually want to build all the spec files, you can either use OBS Links (`_link`), or `_multibuild` files to achieve that.
 Either create links that correspond to the names of the other spec files or create a `_multibuild` file using the spec file names as `flavor`:

```
<multibuild>
  <flavor>foo</flavor>
  <flavor>bar</flavor>
</multibuild>
```

###  ERROR: Source filename in .spec must end in .tar.gz, .tgz, .tar.bz2 or .tar.xz

The (first) `Source:` or `SourceX:` line in your .spec file is malformed. Be
sure to use one of the file extensions mentioned in the error message.

